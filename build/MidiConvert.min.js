'use strict';(function(q,r){"object"===typeof exports&&"undefined"!==typeof module?module.exports=r():"function"===typeof define&&define.amd?define(r):q.MidiConvert=r()})(this,function(){function q(k){function d(d){var g=k.charCodeAt(f);d&&127<g&&(g-=256);f+=1;return g}var f=0;return{eof:function(){return f>=k.length},read:function(d){var g=k.substr(f,d);f+=d;return g},readInt32:function(){var d=(k.charCodeAt(f)<<24)+(k.charCodeAt(f+1)<<16)+(k.charCodeAt(f+2)<<8)+k.charCodeAt(f+3);f+=4;return d},
readInt16:function(){var d=(k.charCodeAt(f)<<8)+k.charCodeAt(f+1);f+=2;return d},readInt8:d,readVarInt:function(){for(var f=0,g=d();g&128;)f+=g&127,f<<=7,g=d();return f+g}}}function r(k){function d(c){var a=c.read(4),e=c.readInt32();return{id:a,length:e,data:c.read(e)}}function f(c){var a={deltaTime:c.readVarInt()},e=c.readInt8(),b,d;if(240===(e&240)){if(255===e)switch(a.type="meta",e=c.readInt8(),b=c.readVarInt(),e){case 0:a.subtype="sequenceNumber";if(2!==b)throw"Expected length for sequenceNumber event is 2, got "+
b;a.number=c.readInt16();return a;case 1:return a.subtype="text",a.text=c.read(b),a;case 2:return a.subtype="copyrightNotice",a.text=c.read(b),a;case 3:return a.subtype="trackName",a.text=c.read(b),a;case 4:return a.subtype="instrumentName",a.text=c.read(b),a;case 5:return a.subtype="lyrics",a.text=c.read(b),a;case 6:return a.subtype="marker",a.text=c.read(b),a;case 7:return a.subtype="cuePoint",a.text=c.read(b),a;case 32:a.subtype="midiChannelPrefix";if(1!==b)throw"Expected length for midiChannelPrefix event is 1, got "+
b;a.channel=c.readInt8();return a;case 47:a.subtype="endOfTrack";if(0!==b)throw"Expected length for endOfTrack event is 0, got "+b;return a;case 81:a.subtype="setTempo";if(3!==b)throw"Expected length for setTempo event is 3, got "+b;a.microsecondsPerBeat=(c.readInt8()<<16)+(c.readInt8()<<8)+c.readInt8();return a;case 84:a.subtype="smpteOffset";if(5!==b)throw"Expected length for smpteOffset event is 5, got "+b;e=c.readInt8();a.frameRate={0:24,32:25,64:29,96:30}[e&96];a.hour=e&31;a.min=c.readInt8();
a.sec=c.readInt8();a.frame=c.readInt8();a.subframe=c.readInt8();return a;case 88:a.subtype="timeSignature";if(4!==b)throw"Expected length for timeSignature event is 4, got "+b;a.numerator=c.readInt8();a.denominator=Math.pow(2,c.readInt8());a.metronome=c.readInt8();a.thirtyseconds=c.readInt8();return a;case 89:a.subtype="keySignature";if(2!==b)throw"Expected length for keySignature event is 2, got "+b;a.key=c.readInt8(!0);a.scale=c.readInt8();return a;case 127:return a.subtype="sequencerSpecific",
a.data=c.read(b),a;default:return a.subtype="unknown",a.data=c.read(b),a}else{if(240===e)return a.type="sysEx",b=c.readVarInt(),a.data=c.read(b),a;if(247===e)return a.type="dividedSysEx",b=c.readVarInt(),a.data=c.read(b),a}throw"Unrecognised MIDI event type byte: "+e;}0===(e&128)?(b=e,e=n):(b=c.readInt8(),n=e);d=e>>4;a.channel=e&15;a.type="channel";switch(d){case 8:return a.subtype="noteOff",a.noteNumber=b,a.velocity=c.readInt8(),a;case 9:return a.noteNumber=b,a.velocity=c.readInt8(),a.subtype=0===
a.velocity?"noteOff":"noteOn",a;case 10:return a.subtype="noteAftertouch",a.noteNumber=b,a.amount=c.readInt8(),a;case 11:return a.subtype="controller",a.controllerType=b,a.value=c.readInt8(),a;case 12:return a.subtype="programChange",a.programNumber=b,a;case 13:return a.subtype="channelAftertouch",a.amount=b,a;case 14:return a.subtype="pitchBend",a.value=b+(c.readInt8()<<7),a;default:throw"Unrecognised MIDI event type: "+d;}}var n;k=q(k);var g=d(k),h=[],l,m,p;if("MThd"!==g.id||6!==g.length)throw"Bad .mid file - header not found";
l=q(g.data);g=l.readInt16();m=l.readInt16();l=l.readInt16();if(l&32768)throw"Expressing time division in SMTPE frames is not supported yet";g={formatType:g,trackCount:m,ticksPerBeat:l};for(m=0;m<g.trackCount;m++){h[m]=[];l=d(k);if("MTrk"!==l.id)throw"Unexpected chunk - expected MTrk, got "+l.id;for(l=q(l.data);!l.eof();)p=f(l),h[m].push(p)}return{header:g,tracks:h}}return{parse:function(k,d){k=r(k);if(0===k.header.formatType){var f={},n=0,g=[],h,l,m,p,c;for(c=0;c<k.tracks[0].length;c++)h=k.tracks[0][c],
l=h.channel||0,n+=h.deltaTime,h.absoluteTime=n,f[l]=f[l]||[],m=f[l][f[l].length-1],f[l].push(h),h.deltaTime=m?h.absoluteTime-m.absoluteTime:h.absoluteTime;k.tracks=[];for(p in f)f.hasOwnProperty(p)&&g.push(f[p]);k.tracks=g;k.header.trackCount=g.length}f=k.header.ticksPerBeat;p=[];var n=!1,a,e,b;d=d||{};d.PPQ="undefined"===typeof d.PPQ?192:d.PPQ;d.noteName="undefined"===typeof d.noteName?!0:d.noteName;d.duration="undefined"===typeof d.duration?!0:d.duration;d.velocity="undefined"===typeof d.velocity?
!0:d.velocity;for(l=0;l<k.tracks.length;l++){m=k.tracks[l];g=[];h=0;if(d.duration)for(m=m.slice(),c=1;c<m.length-1;c++)e=m[c],a=m[c-1],0===e.deltaTime&&"noteOff"===e.subtype&&"noteOn"===a.subtype&&e.noteNumber===a.noteNumber&&(b=e.deltaTime,e.deltaTime=a.deltaTime,a.deltaTime=b,m[c]=a,m[c-1]=e);for(c=0;c<m.length;c++)if(e=m[c],h+=e.deltaTime,"noteOn"===e.subtype)a={_note:e.noteNumber,_ticks:h,midiNote:e.noteNumber,time:h},d.noteName&&(b=e.noteNumber,a.noteName="C C# D D# E F F# G G# A A# B".split(" ")[b%
12]+(Math.floor(b/12)-1)),d.velocity&&(a.velocity=e.velocity/127),g.push(a);else if("noteOff"===e.subtype)for(a=g.length-1;0<=a;a--){if(b=g[a],b._note===e.noteNumber&&"undefined"===typeof b.duration){d.duration&&(b.duration=Math.round((h-b._ticks)/f*d.PPQ)+"i");b.time=Math.round(b.time/f*d.PPQ)+"i";delete b._note;delete b._ticks;break}}else if("meta"===e.type&&"trackName"===e.subtype)e=e.text,e.replace(/\u0000/g,"");else if(64===e.controllerType)if(64<=e.value&&!n)e={_ticks:h,eventName:"sustain",
time:h},n=!0,g.push(e);else if(64>e.value&&n){for(a=g.length-1;0<=a;a--)if(b=g[a],"sustain"===b.eventName&&"undefined"===typeof b.duration){d.duration&&(b.duration=Math.round((h-b._ticks)/f*d.PPQ)+"i");b.time=Math.round(b.time/f*d.PPQ)+"i";delete b._note;delete b._ticks;break}n=!1}0<g.length&&p.push(g)}f={instruments:[]};for(d=0;d<k.tracks.length;d++)for(n=k.tracks[d],g=0;g<n.length;g++)h=n[g],"meta"===h.type?"timeSignature"===h.subtype?f.timeSignature=[h.numerator,h.denominator]:"setTempo"===h.subtype&&
(f.bpm=6E7/h.microsecondsPerBeat):"channel"===h.type&&"programChange"===h.subtype&&f.instruments.push(9===h.channel?0:h.programNumber+1);return{parts:p,transport:f}}}});

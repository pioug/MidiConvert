'use strict';(function(q,r){"object"===typeof exports&&"undefined"!==typeof module?module.exports=r():"function"===typeof define&&define.amd?define(r):q.MidiConvert=r()})(this,function(){function q(k){function e(e){var g=k.charCodeAt(f);e&&127<g&&(g-=256);f+=1;return g}var f=0;return{eof:function(){return f>=k.length},read:function(e){var g=k.substr(f,e);f+=e;return g},readInt32:function(){var e=(k.charCodeAt(f)<<24)+(k.charCodeAt(f+1)<<16)+(k.charCodeAt(f+2)<<8)+k.charCodeAt(f+3);f+=4;return e},
readInt16:function(){var e=(k.charCodeAt(f)<<8)+k.charCodeAt(f+1);f+=2;return e},readInt8:e,readVarInt:function(){for(var f=0,g=e();g&128;)f+=g&127,f<<=7,g=e();return f+g}}}function r(k){function e(c){var a=c.read(4),d=c.readInt32();return{id:a,length:d,data:c.read(d)}}function f(c){var a={deltaTime:c.readVarInt()},d=c.readInt8(),b,e;if(240===(d&240)){if(255===d)switch(a.type="meta",d=c.readInt8(),b=c.readVarInt(),d){case 0:a.subtype="sequenceNumber";if(2!==b)throw"Expected length for sequenceNumber event is 2, got "+
b;a.number=c.readInt16();return a;case 1:return a.subtype="text",a.text=c.read(b),a;case 2:return a.subtype="copyrightNotice",a.text=c.read(b),a;case 3:return a.subtype="trackName",a.text=c.read(b),a;case 4:return a.subtype="instrumentName",a.text=c.read(b),a;case 5:return a.subtype="lyrics",a.text=c.read(b),a;case 6:return a.subtype="marker",a.text=c.read(b),a;case 7:return a.subtype="cuePoint",a.text=c.read(b),a;case 32:a.subtype="midiChannelPrefix";if(1!==b)throw"Expected length for midiChannelPrefix event is 1, got "+
b;a.channel=c.readInt8();return a;case 47:a.subtype="endOfTrack";if(0!==b)throw"Expected length for endOfTrack event is 0, got "+b;return a;case 81:a.subtype="setTempo";if(3!==b)throw"Expected length for setTempo event is 3, got "+b;a.microsecondsPerBeat=(c.readInt8()<<16)+(c.readInt8()<<8)+c.readInt8();return a;case 84:a.subtype="smpteOffset";if(5!==b)throw"Expected length for smpteOffset event is 5, got "+b;d=c.readInt8();a.frameRate={0:24,32:25,64:29,96:30}[d&96];a.hour=d&31;a.min=c.readInt8();
a.sec=c.readInt8();a.frame=c.readInt8();a.subframe=c.readInt8();return a;case 88:a.subtype="timeSignature";if(4!==b)throw"Expected length for timeSignature event is 4, got "+b;a.numerator=c.readInt8();a.denominator=Math.pow(2,c.readInt8());a.metronome=c.readInt8();a.thirtyseconds=c.readInt8();return a;case 89:a.subtype="keySignature";if(2!==b)throw"Expected length for keySignature event is 2, got "+b;a.key=c.readInt8(!0);a.scale=c.readInt8();return a;case 127:return a.subtype="sequencerSpecific",
a.data=c.read(b),a;default:return a.subtype="unknown",a.data=c.read(b),a}else{if(240===d)return a.type="sysEx",b=c.readVarInt(),a.data=c.read(b),a;if(247===d)return a.type="dividedSysEx",b=c.readVarInt(),a.data=c.read(b),a}throw"Unrecognised MIDI event type byte: "+d;}0===(d&128)?(b=d,d=n):(b=c.readInt8(),n=d);e=d>>4;a.channel=d&15;a.type="channel";switch(e){case 8:return a.subtype="noteOff",a.noteNumber=b,a.velocity=c.readInt8(),a;case 9:return a.noteNumber=b,a.velocity=c.readInt8(),a.subtype=0===
a.velocity?"noteOff":"noteOn",a;case 10:return a.subtype="noteAftertouch",a.noteNumber=b,a.amount=c.readInt8(),a;case 11:return a.subtype="controller",a.controllerType=b,a.value=c.readInt8(),a;case 12:return a.subtype="programChange",a.programNumber=b,a;case 13:return a.subtype="channelAftertouch",a.amount=b,a;case 14:return a.subtype="pitchBend",a.value=b+(c.readInt8()<<7),a;default:throw"Unrecognised MIDI event type: "+e;}}var n;k=q(k);var g=e(k),h=[],l,m,p;if("MThd"!==g.id||6!==g.length)throw"Bad .mid file - header not found";
l=q(g.data);g=l.readInt16();m=l.readInt16();l=l.readInt16();if(l&32768)throw"Expressing time division in SMTPE frames is not supported yet";g={formatType:g,trackCount:m,ticksPerBeat:l};for(m=0;m<g.trackCount;m++){h[m]=[];l=e(k);if("MTrk"!==l.id)throw"Unexpected chunk - expected MTrk, got "+l.id;for(l=q(l.data);!l.eof();)p=f(l),h[m].push(p)}return{header:g,tracks:h}}return{parse:function(k,e){k=r(k);if(0===k.header.formatType){var f={},n=0,g=[],h,l,m,p,c;for(c=0;c<k.tracks[0].length;c++)h=k.tracks[0][c],
l=h.channel||0,n+=h.deltaTime,h.absoluteTime=n,f[l]=f[l]||[],m=f[l][f[l].length-1],f[l].push(h),h.deltaTime=m?h.absoluteTime-m.absoluteTime:h.absoluteTime;k.tracks=[];for(p in f)f.hasOwnProperty(p)&&g.push(f[p]);k.tracks=g;k.header.trackCount=g.length}f=k.header.ticksPerBeat;p=[];var n=!1,a,d,b;e=e||{};e.PPQ="undefined"===typeof e.PPQ?192:e.PPQ;e.noteName="undefined"===typeof e.noteName?!0:e.noteName;e.duration="undefined"===typeof e.duration?!0:e.duration;e.velocity="undefined"===typeof e.velocity?
!0:e.velocity;for(l=0;l<k.tracks.length;l++){m=k.tracks[l];g=[];h=0;if(e.duration){c=m;m=c.slice();b:{d={};for(a=0;a<c.length;){b=c[a];if("noteOn"===b.subtype&&d[b.noteNumber]){c=!0;break b}"noteOn"===b.subtype?d[b.noteNumber]=!0:"noteOff"===b.subtype&&(d[b.noteNumber]=!1);a++}c=!1}if(c)for(c=1;c<m.length-1;c++)d=m[c],a=m[c-1],0===d.deltaTime&&"noteOff"===d.subtype&&"noteOn"===a.subtype&&d.noteNumber===a.noteNumber&&(b=d.deltaTime,d.deltaTime=a.deltaTime,a.deltaTime=b,m[c]=a,m[c-1]=d)}for(c=0;c<m.length;c++)if(d=
m[c],h+=d.deltaTime,"noteOn"===d.subtype)a={_note:d.noteNumber,_ticks:h,midiNote:d.noteNumber,time:h},e.noteName&&(b=d.noteNumber,a.noteName="C C# D D# E F F# G G# A A# B".split(" ")[b%12]+(Math.floor(b/12)-1)),e.velocity&&(a.velocity=d.velocity/127),g.push(a);else if("noteOff"===d.subtype)for(a=g.length-1;0<=a;a--){if(b=g[a],b._note===d.noteNumber&&"undefined"===typeof b.duration){e.duration&&(b.duration=Math.round((h-b._ticks)/f*e.PPQ)+"i");b.time=Math.round(b.time/f*e.PPQ)+"i";delete b._note;delete b._ticks;
break}}else if("meta"===d.type&&"trackName"===d.subtype)d=d.text,d.replace(/\u0000/g,"");else if(64===d.controllerType)if(64<=d.value&&!n)d={_ticks:h,eventName:"sustain",time:h},n=!0,g.push(d);else if(64>d.value&&n){for(a=g.length-1;0<=a;a--)if(b=g[a],"sustain"===b.eventName&&"undefined"===typeof b.duration){e.duration&&(b.duration=Math.round((h-b._ticks)/f*e.PPQ)+"i");b.time=Math.round(b.time/f*e.PPQ)+"i";delete b._note;delete b._ticks;break}n=!1}0<g.length&&p.push(g)}f={instruments:[]};for(e=0;e<
k.tracks.length;e++)for(n=k.tracks[e],g=0;g<n.length;g++)h=n[g],"meta"===h.type?"timeSignature"===h.subtype?f.timeSignature=[h.numerator,h.denominator]:"setTempo"===h.subtype&&(f.bpm=6E7/h.microsecondsPerBeat):"channel"===h.type&&"programChange"===h.subtype&&f.instruments.push(9===h.channel?0:h.programNumber+1);return{parts:p,transport:f}}}});

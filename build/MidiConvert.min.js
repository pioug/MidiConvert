'use strict';(function(e,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define(["exports"],n):n(e.MidiConvert=e.MidiConvert||{})})(this,function(e){function n(a){a=/([A-G])(#+|b+)?([0-9]+)$/i.exec(a);var b=a[1].toUpperCase(),c=a[2]||"";return 12*parseInt(a[3],10)+A[b]+("#"===c.substr(0,1)?1:-1)*c.length}function r(a){return"number"!==typeof a&&/[^0-9]/.test(a)?n(a):parseInt(a,10)}function B(a,b){var c=0,d=a;23<a&&(c=Math.floor(a/12)-1,d=
a-12*c);a=C[d];b&&0<a.indexOf("#")&&(a=D[a]);return a+c}function E(a){a=Math.floor(6E7/a);var b=[];do b.unshift(a&255),a>>=8;while(a);for(;3>b.length;)b.push(0);return b}function t(a){return String.fromCharCode.apply(null,a)}function u(a,b){if(b)for(;a.length/2<b;)a="0"+a;b=[];var c,d;for(d=a.length-1;0<=d;d-=2)c=0===d?a[d]:a[d-1]+a[d],b.unshift(parseInt(c,16));return b}function v(a){var b=a&127,c=!0,d=[];for(a>>=7;a;)b<<=8,b|=a&127|128,a>>=7;for(;c;)d.push(b&255),b&128?b>>=8:c=!1;return d}function p(a){var b=
a.time,c=a.type,d=a.channel,f=a.param1,k=a.param2;if(c<h.NOTE_OFF||c>h.PITCH_BEND)throw Error("Trying to set an unknown event: "+c);if(0>d||15<d)throw Error("Channel is out of bounds.");b=v(b||0);return{toBytes:function(){var a=[],e=c|d&15;a.push.apply(a,b);a.push(e);a.push(f);"undefined"!==typeof k&&null!==k&&a.push(k);return a}}}function x(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function F(a,b){return a.concat(b)}function H(a){return!!a}function I(a,b){if(b.name.includes("Note"))a["add"+
b.name](0,b.midiNote,b.deltaTime,127*b.velocity);else if(b.name.includes("Sustain"))a["add"+b.name](0,b.deltaTime);return a}function J(a,b,c,d){var f=a[a.length-1],k=b;if(!a.length)return k.taken=!0,[k];k=d.find(function(a){return!a.taken&&a.time>=f.time});b=a.filter(function(a){return a.midiNote===k.midiNote}).pop();if(!b)return k.taken=!0,a.concat(k);d=d.filter(function(a){return!a.taken&&a.time===k.time});b&&b.name.includes("On")?k=d.find(function(a){return a.name.includes("Off")})||k:b&&b.name.includes("Off")&&
(k=d.find(function(a){return a.name.includes("On")})||k);k.taken=!0;return a.concat(k)}function K(a,b){return a.time-b.time}function L(a){if("undefined"!==typeof a.midiNote)return[{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOn",time:parseInt(a.time),velocity:a.velocity},{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOff",time:parseInt(a.time)+parseInt(a.duration),velocity:a.velocity}];if("sustain"===a.eventName)return[{name:"SustainOn",time:parseInt(a.time)},{name:"SustainOff",
time:parseInt(a.time)+parseInt(a.duration)}]}function M(a,b,c,d){return a.concat({duration:b.duration,time:b.time,name:b.name,midiNote:b.midiNote,deltaTime:0!==a.length?b.time-d[c-1].time:b.time,velocity:b.velocity})}function y(a){function b(b){var f=a.charCodeAt(c);b&&127<f&&(f-=256);c+=1;return f}var c=0;return{eof:function(){return c>=a.length},read:function(b){var f=a.substr(c,b);c+=b;return f},readInt32:function(){var b=(a.charCodeAt(c)<<24)+(a.charCodeAt(c+1)<<16)+(a.charCodeAt(c+2)<<8)+a.charCodeAt(c+
3);c+=4;return b},readInt16:function(){var b=(a.charCodeAt(c)<<8)+a.charCodeAt(c+1);c+=2;return b},readInt8:b,readVarInt:function(){for(var a=0,c=b();c&128;)a+=c&127,a<<=7,c=b();return a+c}}}function N(a){function b(a){var b=a.read(4),c=a.readInt32();return{id:b,length:c,data:a.read(c)}}function c(a){var b={deltaTime:a.readVarInt()},c=a.readInt8(),f;if(240===(c&240)){if(255===c)switch(b.type="meta",b.subtype=a.readInt8(),c=a.readVarInt(),b.subtype){case g.COPYRIGHT_NOTICE:case g.CUE_POINT:case g.INSTRUMENT_NAME:case g.LYRICS:case g.MARKER:case g.SEQUENCER_SPECIFIC:case g.TEXT:case g.TRACK_NAME:return b.text=
a.read(c),b;case g.SEQUENCE_NUMBER:if(2!==c)throw"Expected length for sequenceNumber event is 2, got "+c;b.number=a.readInt16();return b;case g.MIDI_CHANNEL_PREFIX:if(1!==c)throw"Expected length for midiChannelPrefix event is 1, got "+c;b.channel=a.readInt8();return b;case g.END_OF_TRACK:if(0!==c)throw"Expected length for endOfTrack event is 0, got "+c;return b;case g.SET_TEMPO:if(3!==c)throw"Expected length for setTempo event is 3, got "+c;b.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<
8)+a.readInt8();return b;case g.SMPTE_OFFSET:if(5!==c)throw"Expected length for smpteOffset event is 5, got "+c;c=a.readInt8();b.frameRate={0:24,32:25,64:29,96:30}[c&96];b.hour=c&31;b.min=a.readInt8();b.sec=a.readInt8();b.frame=a.readInt8();b.subframe=a.readInt8();return b;case g.TIME_SIGNATURE:if(4!==c)throw"Expected length for timeSignature event is 4, got "+c;b.numerator=a.readInt8();b.denominator=Math.pow(2,a.readInt8());b.metronome=a.readInt8();b.thirtyseconds=a.readInt8();return b;case g.KEY_SIGNATURE:if(2!==
c)throw"Expected length for keySignature event is 2, got "+c;b.key=a.readInt8(!0);b.scale=a.readInt8();return b;default:return b.subtype="unknown",b.data=a.read(c),b}else{if(240===c)return b.type="sysEx",c=a.readVarInt(),b.data=a.read(c),b;if(247===c)return b.type="dividedSysEx",c=a.readVarInt(),b.data=a.read(c),b}throw"Unrecognised MIDI event type byte: "+c;}0===(c&128)?(f=c,c=d):(f=a.readInt8(),d=c);b.subtype=c&240;b.channel=c&15;b.type="channel";switch(b.subtype){case h.NOTE_OFF:return b.noteNumber=
f,b.velocity=a.readInt8(),b;case h.NOTE_ON:return b.noteNumber=f,b.velocity=a.readInt8(),b.subtype=0===b.velocity?h.NOTE_OFF:h.NOTE_ON,b;case h.AFTER_TOUCH:return b.noteNumber=f,b.amount=a.readInt8(),b;case h.CONTROL_CHANGE:return b.controllerType=f,b.value=a.readInt8(),b;case h.PROGRAM_CHANGE:return b.programNumber=f,b;case h.CHANNEL_AFTERTOUCH:return b.amount=f,b;case h.PITCH_BEND:return b.value=f+(a.readInt8()<<7),b;default:throw"Unrecognised MIDI event type: undefined";}}var d;a=y(a);var f=b(a),
k=[],e,w,q,m,G;if("MThd"!==f.id||6!==f.length)throw"Bad .mid file - header not found";e=y(f.data);f=e.readInt16();w=e.readInt16();e=e.readInt16();if(e&32768)throw"Expressing time division in SMTPE frames is not supported yet";for(q=0;q<w;q++){k[q]=[];m=b(a);if("MTrk"!==m.id)throw"Unexpected chunk - expected MTrk, got "+m.id;for(m=y(m.data);!m.eof();)G=c(m),k[q].push(G)}return{header:{formatType:f,trackCount:w,ticksPerBeat:e},tracks:k}}function O(a,b){b=Object.assign({deterministic:!1,duration:!0,
noteName:!0,PPQ:128},b);return a.tracks.reduce(function(c,d){function f(c){c.time=(Math.round(c.time/a.header.ticksPerBeat*b.PPQ)||0)+"i";c.duration=(Math.round(c.duration/a.header.ticksPerBeat*b.PPQ)||0)+"i";return c}var e=0,g=!1;d=d.reduce(function(a,c){var d;e+=c.deltaTime;switch(!0){case c.subtype===h.NOTE_ON:if(d=a.filter(function(a){return a.midiNote===c.noteNumber&&"undefined"===typeof a.duration}).pop())d.duration=e-d.time;d={time:e,midiNote:c.noteNumber,velocity:c.velocity/127};b.noteName&&
(d.noteName=B(c.noteNumber));return a.concat(d);case c.subtype===h.NOTE_OFF:if(d=a.filter(function(a){return a.midiNote===c.noteNumber&&"undefined"===typeof a.duration}).pop())d.duration=e-d.time;return a;case c.controllerType===h.CONTROLLER.DAMPER_PEDAL&&64<=c.value&&!g:return d={eventName:"sustain",time:e},g=!0,a.concat(d);case c.controllerType===h.CONTROLLER.DAMPER_PEDAL&&64>c.value&&g:if(d=a.filter(function(a){return"sustain"===a.eventName&&"undefined"===typeof a.duration}).pop())d.duration=e-
d.time;g=!1;return a;default:return a}},[]).filter(function(a,b,c){return!c.find(function(b){return b!==a&&b.midiNote===a.midiNote&&b.time===a.time&&b.duration>a.duration})});b.duration&&(d=d.map(f));b.deterministic&&(d=d.sort(P));return 0===d.length?c:c.concat([d])},[])}function P(a,b){var c=parseInt(a.time)-parseInt(b.time),d=a.midiNote&&b.midiNote&&a.midiNote-b.midiNote,f=parseInt(b.duration)-parseInt(a.duration);a=b.velocity-a.velocity;return c||d||f||a}function Q(a,b,c){var d=b.filter(function(a){return a.subtype===
g.TRACK_NAME}).pop();b=b.filter(function(a){return a.subtype===h.NOTE_ON}).length;d&&b&&(a[c]=d.text.replace(/\u0000/g,""));return a}function R(a,b){(b=b.filter(function(a){return a.subtype===h.PROGRAM_CHANGE}).pop())&&(a[b.channel]=9===b.channel?0:b.programNumber+1);return a}function S(a){return(a=a.filter(function(a){return a.subtype===g.TIME_SIGNATURE}).pop())?[a.numerator,a.denominator]:null}function T(a){return(a=a.filter(function(a){return a.subtype===g.SET_TEMPO}).pop())?6E7/a.microsecondsPerBeat:
null}function U(a){var b=0;a=a.reduce(function(a,d){var f=d.channel||0,e;a[f]=a[f]||[];e=a[f][a[f].length-1];a[f].push(d);b+=d.deltaTime;d.absoluteTime=b;d.deltaTime=e?d.absoluteTime-e.absoluteTime:d.absoluteTime;return a},{});return x(a)}var h={NOTE_OFF:128,NOTE_ON:144,AFTER_TOUCH:160,CONTROL_CHANGE:176,CONTROLLER:{DAMPER_PEDAL:64},PROGRAM_CHANGE:192,CHANNEL_AFTERTOUCH:208,PITCH_BEND:224},g={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,
PROGRAM_NAME:8,DEVICE_NAME:9,MIDI_CHANNEL_PREFIX:32,MIDI_PORT:33,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127},D={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"},A={A:21,B:23,C:12,D:14,E:16,F:17,G:19},C={12:"C",13:"C#",14:"D",15:"D#",16:"E",17:"F",18:"F#",19:"G",20:"G#",21:"A",22:"A#",23:"B"},z=function(a){var b=a.time,c=a.type,d=a.data,b=v(b||0);return{toBytes:function(){if(!c)throw Error("Type for meta-event not specified.");var a=[],
e;a.push.apply(a,b);a.push(255,c);Array.isArray(d)?(a.push(d.length),a.push.apply(a,d)):"number"===typeof d?a.push(1,d):null!==d&&"undefined"!==typeof d?(a.push(d.length),e=d.split("").map(function(a){return a.charCodeAt(0)}),a.push.apply(a,e)):a.push(0);return a}}};e.Track=function(a){if(!this)return new e.Track(a);this.events=(a||{}).events||[]};e.Track.START_BYTES=[77,84,114,107];e.Track.END_BYTES=[0,255,47,0];e.Track.prototype.addEvent=function(a){this.events.push(a);return this};e.Track.prototype.addNoteOn=
function(a,b,c,d){this.events.push(new p({type:h.NOTE_ON,channel:a,param1:r(b),param2:d||90,time:c||0}));return this};e.Track.prototype.addNoteOff=function(a,b,c,d){this.events.push(new p({type:h.NOTE_OFF,channel:a,param1:r(b),param2:d||90,time:c||0}));return this};e.Track.prototype.addSustainOn=function(a,b){this.events.push(new p({type:h.CONTROL_CHANGE,channel:a,param1:h.CONTROLLER.DAMPER_PEDAL,param2:127,time:b||0}));return this};e.Track.prototype.addSustainOff=function(a,b){this.events.push(new p({type:h.CONTROL_CHANGE,
channel:a,param1:h.CONTROLLER.DAMPER_PEDAL,param2:0,time:b||0}));return this};e.Track.prototype.addNote=function(a,b,c,d,e){this.noteOn(a,b,d,e);c&&this.noteOff(a,b,c,e);return this};e.Track.prototype.addChord=function(a,b,c,d){if(!Array.isArray(b)&&!b.length)throw Error("Chord must be an array of pitches");b.forEach(function(b){this.noteOn(a,b,0,d)},this);b.forEach(function(b,d){0===d?this.noteOff(a,b,c):this.noteOff(a,b)},this);return this};e.Track.prototype.setInstrument=function(a,b,c){this.events.push(new p({type:h.PROGRAM_CHANGE,
channel:a,param1:b,time:c||0}));return this};e.Track.prototype.setTimeSignature=function(a,b,c){this.events.push(new z({type:g.TIME_SIGNATURE,data:[a,Math.log2(b),24,8],time:c||0}));return this};e.Track.prototype.setTempo=function(a,b){this.events.push(new z({type:g.SET_TEMPO,data:E(a),time:b||0}));return this};e.Track.prototype.setName=function(a,b){this.events.push(new z({type:g.TRACK_NAME,data:a,time:b||0}));return this};e.Track.prototype.toBytes=function(){var a=0,b=[],c,d=e.Track.START_BYTES,
f=e.Track.END_BYTES;this.events.forEach(function(c){c=c.toBytes();a+=c.length;b.push.apply(b,c)});a+=f.length;c=u(a.toString(16),4);return d.concat(c,b,f)};var l=function(a){if(!this)return new l(a);a=a||{};if(a.ticks){if("number"!==typeof a.ticks)throw Error("Ticks per beat must be a number!");if(0>=a.ticks||32768<=a.ticks||0!==a.ticks%1)throw Error("Ticks per beat must be an integer between 1 and 32767!");}this.ticks=a.ticks||128;this.tracks=a.tracks||[]};l.HDR_CHUNKID="MThd";l.HDR_CHUNK_SIZE="\x00\x00\x00\u0006";
l.HDR_TYPE0="\x00\x00";l.HDR_TYPE1="\x00\u0001";l.prototype.addTrack=function(a){if(a)return this.tracks.push(a),this;a=new e.Track;this.tracks.push(a);return a};l.prototype.toBytes=function(){var a=this.tracks.length.toString(16),b=l.HDR_CHUNKID+l.HDR_CHUNK_SIZE,b=1<parseInt(a,16)?b+l.HDR_TYPE1:b+l.HDR_TYPE0,b=b+t(u(a,2)),b=b+String.fromCharCode(this.ticks/256,this.ticks%256);this.tracks.forEach(function(a){b+=t(a.toBytes())});return b};e.generate=function(a){var b=new l;a.parts.forEach(function(c,
d){var e=b.addTrack();a.transport.bpm&&e.setTempo(a.transport.bpm);a.transport.instruments&&"undefined"!==typeof a.transport.instruments[d]&&e.setInstrument(0===a.transport.instruments[d]?9:9<=d?d+1:d,a.transport.instruments[d]-1);a.transport.timeSignature&&e.setTimeSignature(a.transport.timeSignature[0],a.transport.timeSignature[1]);a.transport.trackNames&&a.transport.trackNames[d]&&e.setName(a.transport.trackNames[d]);c.map(L).filter(H).reduce(F,[]).sort(K).reduce(J,[]).reduce(M,[]).reduce(I,e)});
return b.toBytes()};e.parse=function(a,b){a=N(a);0===a.header.formatType&&(a.tracks=U(a.tracks[0]));b=O(a,b);var c=a.tracks.reduce(F,[]),d=a.tracks.reduce(R,{});a=a.tracks.reduce(Q,{});a={bpm:T(c),instruments:x(d),timeSignature:S(c),trackNames:x(a)};return{parts:b,transport:a}};e.File=l;e.bpmFromMpqn=function(a){return Math.floor(6E7/a)};e.codes2Str=t;e.ensureMidiPitch=r;e.midiPitchFromNote=n;e.mpqnFromBpm=E;e.noteFromMidiPitch=B;e.secondsToTicks=function(a,b,c){return Math.ceil(a/60*b*(void 0===
c?128:c))};e.str2Bytes=u;e.ticksToSeconds=function(a,b,c){return 60/b*a/(void 0===c?128:c)};e.translateTickTime=v;e.midiFlattenedNotes=D;e.midiLetterPitches=A;e.midiPitchesLetter=C;Object.defineProperty(e,"__esModule",{value:!0})});

'use strict';(function(w,x){"object"===typeof exports&&"undefined"!==typeof module?module.exports=x():"function"===typeof define&&define.amd?define(x):w.MidiConvert=x()})(this,function(){function w(a){function b(b){var g=a.charCodeAt(c);b&&127<g&&(g-=256);c+=1;return g}var c=0;return{eof:function(){return c>=a.length},read:function(b){var g=a.substr(c,b);c+=b;return g},readInt32:function(){var b=(a.charCodeAt(c)<<24)+(a.charCodeAt(c+1)<<16)+(a.charCodeAt(c+2)<<8)+a.charCodeAt(c+3);c+=4;return b},
readInt16:function(){var b=(a.charCodeAt(c)<<8)+a.charCodeAt(c+1);c+=2;return b},readInt8:b,readVarInt:function(){for(var a=0,c=b();c&128;)a+=c&127,a<<=7,c=b();return a+c}}}function x(a){function b(a){var b=a.read(4),c=a.readInt32();return{id:b,length:c,data:a.read(c)}}function c(a){var b={deltaTime:a.readVarInt()},c=a.readInt8(),d,g;if(240===(c&240)){if(255===c)switch(b.type="meta",c=a.readInt8(),d=a.readVarInt(),c){case q.SEQUENCE_NUMMBER:b.subtype="sequenceNumber";if(2!==d)throw"Expected length for sequenceNumber event is 2, got "+
d;b.number=a.readInt16();return b;case q.TEXT:return b.subtype="text",b.text=a.read(d),b;case q.COPYRIGHT_NOTICE:return b.subtype="copyrightNotice",b.text=a.read(d),b;case q.TRACK_NAME:return b.subtype="trackName",b.text=a.read(d),b;case q.INSTRUMENT_NAME:return b.subtype="instrumentName",b.text=a.read(d),b;case q.LYRICS:return b.subtype="lyrics",b.text=a.read(d),b;case q.MARKER:return b.subtype="marker",b.text=a.read(d),b;case q.CUE_POINT:return b.subtype="cuePoint",b.text=a.read(d),b;case q.MIDI_CHANNEL_PREFIX:b.subtype=
"midiChannelPrefix";if(1!==d)throw"Expected length for midiChannelPrefix event is 1, got "+d;b.channel=a.readInt8();return b;case q.END_OF_TRACK:b.subtype="endOfTrack";if(0!==d)throw"Expected length for endOfTrack event is 0, got "+d;return b;case q.SET_TEMPO:b.subtype="setTempo";if(3!==d)throw"Expected length for setTempo event is 3, got "+d;b.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8();return b;case q.SMPTE_OFFSET:b.subtype="smpteOffset";if(5!==d)throw"Expected length for smpteOffset event is 5, got "+
d;c=a.readInt8();b.frameRate={0:24,32:25,64:29,96:30}[c&96];b.hour=c&31;b.min=a.readInt8();b.sec=a.readInt8();b.frame=a.readInt8();b.subframe=a.readInt8();return b;case q.TIME_SIGNATURE:b.subtype="timeSignature";if(4!==d)throw"Expected length for timeSignature event is 4, got "+d;b.numerator=a.readInt8();b.denominator=Math.pow(2,a.readInt8());b.metronome=a.readInt8();b.thirtyseconds=a.readInt8();return b;case q.KEY_SIGNATURE:b.subtype="keySignature";if(2!==d)throw"Expected length for keySignature event is 2, got "+
d;b.key=a.readInt8(!0);b.scale=a.readInt8();return b;case q.SEQUENCER_SPECIFIC:return b.subtype="sequencerSpecific",b.data=a.read(d),b;default:return b.subtype="unknown",b.data=a.read(d),b}else{if(240===c)return b.type="sysEx",d=a.readVarInt(),b.data=a.read(d),b;if(247===c)return b.type="dividedSysEx",d=a.readVarInt(),b.data=a.read(d),b}throw"Unrecognised MIDI event type byte: "+c;}0===(c&128)?(d=c,c=e):(d=a.readInt8(),e=c);g=c&240;b.channel=c&15;b.type="channel";switch(g){case r.NOTE_OFF:return b.subtype=
"noteOff",b.noteNumber=d,b.velocity=a.readInt8(),b;case r.NOTE_ON:return b.noteNumber=d,b.velocity=a.readInt8(),b.subtype=0===b.velocity?"noteOff":"noteOn",b;case r.AFTER_TOUCH:return b.subtype="noteAftertouch",b.noteNumber=d,b.amount=a.readInt8(),b;case r.CONTROL_CHANGE:return b.subtype="controlChange",b.controllerType=d,b.value=a.readInt8(),b;case r.PROGRAM_CHANGE:return b.subtype="programChange",b.programNumber=d,b;case r.CHANNEL_AFTERTOUCH:return b.subtype="channelAftertouch",b.amount=d,b;case r.PITCH_BEND:return b.subtype=
"pitchBend",b.value=d+(a.readInt8()<<7),b;default:throw"Unrecognised MIDI event type: "+g;}}var e;a=w(a);var g=b(a),y=[],h,n,f;if("MThd"!==g.id||6!==g.length)throw"Bad .mid file - header not found";h=w(g.data);g=h.readInt16();n=h.readInt16();h=h.readInt16();if(h&32768)throw"Expressing time division in SMTPE frames is not supported yet";g={formatType:g,trackCount:n,ticksPerBeat:h};for(n=0;n<g.trackCount;n++){y[n]=[];h=b(a);if("MTrk"!==h.id)throw"Unexpected chunk - expected MTrk, got "+h.id;for(h=w(h.data);!h.eof();)f=
c(h),y[n].push(f)}return{header:g,tracks:y}}function E(a){a=/([A-G])(#+|b+)?([0-9]+)$/i.exec(a);var b=a[1].toUpperCase(),c=a[2]||"";return 12*parseInt(a[3],10)+F[b]+("#"===c.substr(0,1)?1:-1)*c.length}function z(a){return"number"!==typeof a&&/[^0-9]/.test(a)?E(a):parseInt(a,10)}function G(a,b){var c=0,e=a;23<a&&(c=Math.floor(a/12)-1,e=a-12*c);a=H[e];b&&0<a.indexOf("#")&&(a=I[a]);return a+c}function J(a){a=Math.floor(6E7/a);var b=[];do b.unshift(a&255),a>>=8;while(a);for(;3>b.length;)b.push(0);return b}
function A(a){return String.fromCharCode.apply(null,a)}function B(a,b){if(b)for(;a.length/2<b;)a="0"+a;b=[];var c,e;for(e=a.length-1;0<=e;e-=2)c=0===e?a[e]:a[e-1]+a[e],b.unshift(parseInt(c,16));return b}function C(a){var b=a&127,c=!0,e=[];for(a>>=7;a;)b<<=8,b|=a&127|128,a>>=7;for(;c;)e.push(b&255),b&128?b>>=8:c=!1;return e}function L(a,b){if(b.name.includes("Note"))a["add"+b.name](0,b.midiNote,b.deltaTime,127*b.velocity);else if(b.name.includes("Sustain"))a["add"+b.name](0,b.deltaTime);return a}function M(a,
b,c,e){function g(a){return!a.taken&&a.time===h.time}var y=a[a.length-1],h;if(!a.length)return h=e[0],h.taken=!0,[h];h=e.find(function(a){return!a.taken&&a.time>=y.time});if(!h.duration)return h.taken=!0,a.concat(h);h=e.filter(g).find(function(a){return a.name.includes("Off")})||e.filter(g).find(function(a){return a.duration>h.duration})||h;h.taken=!0;return a.concat(h)}function N(a,b){return a.time-b.time}function O(a,b){return a.concat(b)}function P(a){if("undefined"!==typeof a.midiNote)return[{duration:parseInt(a.duration),
midiNote:a.midiNote,name:"NoteOn",time:parseInt(a.time),velocity:a.velocity},{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOff",time:parseInt(a.time)+parseInt(a.duration),velocity:a.velocity}];if("sustain"===a.eventName)return[{name:"SustainOn",time:parseInt(a.time)},{name:"SustainOff",time:parseInt(a.time)+parseInt(a.duration)}]}function Q(a,b,c,e){return a.concat({duration:b.duration,time:b.time,name:b.name,midiNote:b.midiNote,deltaTime:0!==a.length?b.time-e[c-1].time:b.time,velocity:b.velocity})}
function R(a,b){var c=parseInt(a.time)-parseInt(b.time),e=a.midiNote&&b.midiNote&&a.midiNote-b.midiNote,g=parseInt(b.duration)-parseInt(a.duration);a=b.velocity-a.velocity;return c||e||g||a}function D(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}var r={NOTE_OFF:128,NOTE_ON:144,AFTER_TOUCH:160,CONTROL_CHANGE:176,CONTROLLER:{DAMPER_PEDAL:64},PROGRAM_CHANGE:192,CHANNEL_AFTERTOUCH:208,PITCH_BEND:224},q={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,
LYRICS:5,MARKER:6,CUE_POINT:7,PROGRAM_NAME:8,DEVICE_NAME:9,MIDI_CHANNEL_PREFIX:32,MIDI_PORT:33,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127},I={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"},F={A:21,B:23,C:12,D:14,E:16,F:17,G:19},H={12:"C",13:"C#",14:"D",15:"D#",16:"E",17:"F",18:"F#",19:"G",20:"G#",21:"A",22:"A#",23:"B"},v=function(a){if(!this)return new v(a);this.setTime(a.time);this.setType(a.type);this.setData(a.data)};v.prototype.setTime=
function(a){this.time=C(a||0)};v.prototype.setType=function(a){this.type=a};v.prototype.setData=function(a){this.data=a};v.prototype.toBytes=function(){if(!this.type)throw Error("Type for meta-event not specified.");var a=[],b;a.push.apply(a,this.time);a.push(255,this.type);Array.isArray(this.data)?(a.push(this.data.length),a.push.apply(a,this.data)):"number"===typeof this.data?a.push(1,this.data):null!==this.data&&"undefined"!==typeof this.data?(a.push(this.data.length),b=this.data.split("").map(function(a){return a.charCodeAt(0)}),
a.push.apply(a,b)):a.push(0);return a};var t=function(a){if(!this)return new t(a);!a||null===a.type&&"undefined"===typeof a.type||null===a.channel&&"undefined"===typeof a.channel||null===a.param1&&"undefined"===typeof a.param1||(this.setTime(a.time),this.setType(a.type),this.setChannel(a.channel),this.setParam1(a.param1),this.setParam2(a.param2))};t.prototype.setTime=function(a){this.time=C(a||0)};t.prototype.setType=function(a){if(a<r.NOTE_OFF||a>r.PITCH_BEND)throw Error("Trying to set an unknown event: "+
a);this.type=a};t.prototype.setChannel=function(a){if(0>a||15<a)throw Error("Channel is out of bounds.");this.channel=a};t.prototype.setParam1=function(a){this.param1=a};t.prototype.setParam2=function(a){this.param2=a};t.prototype.toBytes=function(){var a=[],b=this.type|this.channel&15;a.push.apply(a,this.time);a.push(b);a.push(this.param1);"undefined"!==typeof this.param2&&null!==this.param2&&a.push(this.param2);return a};var f;f=function(a){if(!this)return new f(a);this.events=(a||{}).events||[]};
f.START_BYTES=[77,84,114,107];f.END_BYTES=[0,255,47,0];f.prototype.addEvent=function(a){this.events.push(a);return this};f.prototype.addNoteOn=f.prototype.noteOn=function(a,b,c,e){this.events.push(new t({type:r.NOTE_ON,channel:a,param1:z(b),param2:e||90,time:c||0}));return this};f.prototype.addNoteOff=f.prototype.noteOff=function(a,b,c,e){this.events.push(new t({type:r.NOTE_OFF,channel:a,param1:z(b),param2:e||90,time:c||0}));return this};f.prototype.addSustainOn=f.prototype.sustainOn=function(a,b){this.events.push(new t({type:r.CONTROL_CHANGE,
channel:a,param1:r.CONTROLLER.DAMPER_PEDAL,param2:127,time:b||0}));return this};f.prototype.addSustainOff=f.prototype.sustainOff=function(a,b){this.events.push(new t({type:r.CONTROL_CHANGE,channel:a,param1:r.CONTROLLER.DAMPER_PEDAL,param2:0,time:b||0}));return this};f.prototype.addNote=f.prototype.note=function(a,b,c,e,g){this.noteOn(a,b,e,g);c&&this.noteOff(a,b,c,g);return this};f.prototype.addChord=f.prototype.chord=function(a,b,c,e){if(!Array.isArray(b)&&!b.length)throw Error("Chord must be an array of pitches");
b.forEach(function(b){this.noteOn(a,b,0,e)},this);b.forEach(function(b,e){0===e?this.noteOff(a,b,c):this.noteOff(a,b)},this);return this};f.prototype.setInstrument=f.prototype.instrument=function(a,b,c){this.events.push(new t({type:r.PROGRAM_CHANGE,channel:a,param1:b,time:c||0}));return this};f.prototype.setTimeSignature=f.prototype.timeSignature=function(a,b,c){this.events.push(new v({type:q.TIME_SIGNATURE,data:[a,Math.log2(b),24,8],time:c||0}));return this};f.prototype.setTempo=f.prototype.tempo=
function(a,b){this.events.push(new v({type:q.SET_TEMPO,data:J(a),time:b||0}));return this};f.prototype.toBytes=function(){var a=0,b=[],c,e=f.START_BYTES,g=f.END_BYTES;this.events.forEach(function(c){c=c.toBytes();a+=c.length;b.push.apply(b,c)});a+=g.length;c=B(a.toString(16),4);return e.concat(c,b,g)};var u=function(a){if(!this)return new u(a);a=a||{};if(a.ticks){if("number"!==typeof a.ticks)throw Error("Ticks per beat must be a number!");if(0>=a.ticks||32768<=a.ticks||0!==a.ticks%1)throw Error("Ticks per beat must be an integer between 1 and 32767!");
}this.ticks=a.ticks||128;this.tracks=a.tracks||[]};u.HDR_CHUNKID="MThd";u.HDR_CHUNK_SIZE="\x00\x00\x00\u0006";u.HDR_TYPE0="\x00\x00";u.HDR_TYPE1="\x00\u0001";u.prototype.addTrack=function(a){if(a)return this.tracks.push(a),this;a=new f;this.tracks.push(a);return a};u.prototype.toBytes=function(){var a=this.tracks.length.toString(16),b=u.HDR_CHUNKID+u.HDR_CHUNK_SIZE,b=1<parseInt(a,16)?b+u.HDR_TYPE1:b+u.HDR_TYPE0,b=b+A(B(a,2)),b=b+String.fromCharCode(this.ticks/256,this.ticks%256);this.tracks.forEach(function(a){b+=
A(a.toBytes())});return b};var K={File:u,Track:f,MidiEvent:t,MetaEvent:v,Util:{midiLetterPitches:F,midiPitchesLetter:H,midiFlattenedNotes:I,midiPitchFromNote:E,ensureMidiPitch:z,noteFromMidiPitch:G,mpqnFromBpm:J,bpmFromMpqn:function(a){return Math.floor(6E7/a)},codes2Str:A,str2Bytes:B,translateTickTime:C}};return{generate:function(a){var b=new K.File;a.parts.forEach(function(c,e){var g=b.addTrack();a.transport.bpm&&g.setTempo(a.transport.bpm);a.transport._instruments&&"undefined"!==typeof a.transport._instruments[e]&&
g.setInstrument("percussion"===a.transport._instruments[e]?9:9<=e?e+1:e,a.transport._instruments[e]);a.transport.timeSignature&&g.setTimeSignature(a.transport.timeSignature[0],a.transport.timeSignature[1]);c.map(P).reduce(O,[]).sort(N).reduce(M,[]).reduce(Q,[]).reduce(L,g)});return b.toBytes()},MidiGen:K,parse:function(a,b){a=x(a);if(0===a.header.formatType){var c={},e=0,g,f,h,n;for(n=0;n<a.tracks[0].length;n++)g=a.tracks[0][n],f=g.channel||0,e+=g.deltaTime,g.absoluteTime=e,c[f]=c[f]||[],h=c[f][c[f].length-
1],c[f].push(g),g.deltaTime=h?g.absoluteTime-h.absoluteTime:g.absoluteTime;a.tracks=D(c);a.header.trackCount=0}e=a.header.ticksPerBeat;c=[];g=!1;var l,p,m,k,d;b=b||{};b.PPQ="undefined"===typeof b.PPQ?128:b.PPQ;b.noteName="undefined"===typeof b.noteName?!0:b.noteName;b.duration="undefined"===typeof b.duration?!0:b.duration;b.velocity="undefined"===typeof b.velocity?!0:b.velocity;for(n=0;n<a.tracks.length;n++){l=a.tracks[n];f=[];h=0;if(b.duration){p=l;l=p.slice();b:{k={};for(m=0;m<p.length;){d=p[m];
if("noteOn"===d.subtype&&k[d.noteNumber]){p=!0;break b}"noteOn"===d.subtype?k[d.noteNumber]=!0:"noteOff"===d.subtype&&(k[d.noteNumber]=!1);m++}p=!1}if(p)for(p=1;p<l.length-1;p++)k=l[p],m=l[p-1],0===k.deltaTime&&"noteOff"===k.subtype&&"noteOn"===m.subtype&&k.noteNumber===m.noteNumber&&(d=k.deltaTime,k.deltaTime=m.deltaTime,m.deltaTime=d,l[p]=m,l[p-1]=k)}for(p=0;p<l.length;p++)if(k=l[p],h+=k.deltaTime,"noteOn"===k.subtype)m={_note:k.noteNumber,_ticks:h,midiNote:k.noteNumber,time:h},b.noteName&&(m.noteName=
G(k.noteNumber)),b.velocity&&(m.velocity=k.velocity/127),f.push(m);else if("noteOff"===k.subtype)for(m=f.length-1;0<=m;m--){if(d=f[m],d._note===k.noteNumber&&"undefined"===typeof d.duration){b.duration&&(d.duration=Math.round((h-d._ticks)/e*b.PPQ)+"i");d.time=Math.round(d.time/e*b.PPQ)+"i";delete d._note;delete d._ticks;break}}else if("meta"===k.type&&"trackName"===k.subtype)k=k.text,k.replace(/\u0000/g,"");else if(k.controllerType===r.CONTROLLER.DAMPER_PEDAL)if(64<=k.value&&!g)k={_ticks:h,eventName:"sustain",
time:h},g=!0,f.push(k);else if(64>k.value&&g){for(m=f.length-1;0<=m;m--)if(d=f[m],"sustain"===d.eventName&&"undefined"===typeof d.duration){b.duration&&(d.duration=Math.round((h-d._ticks)/e*b.PPQ)+"i");d.time=Math.round(d.time/e*b.PPQ)+"i";delete d._note;delete d._ticks;break}g=!1}b.deterministic&&(f=f.sort(R));0<f.length&&c.push(f)}e={};g={};b={};for(h=0;h<a.tracks.length;h++)for(f=a.tracks[h],n=0;n<f.length;n++)l=f[n],"meta"===l.type?"timeSignature"===l.subtype?e.timeSignature=[l.numerator,l.denominator]:
"setTempo"===l.subtype&&(e.bpm=6E7/l.microsecondsPerBeat):"channel"===l.type&&"programChange"===l.subtype&&(g[l.channel]=9===l.channel?0:l.programNumber+1,b[l.channel]=9===l.channel?"percussion":l.programNumber);e.instruments=D(g);e._instruments=D(b);return{parts:c,transport:e}}}});

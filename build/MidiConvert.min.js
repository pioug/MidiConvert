'use strict';(function(v,w){"object"===typeof exports&&"undefined"!==typeof module?module.exports=w():"function"===typeof define&&define.amd?define(w):v.MidiConvert=w()})(this,function(){function v(a){function b(b){var f=a.charCodeAt(c);b&&127<f&&(f-=256);c+=1;return f}var c=0;return{eof:function(){return c>=a.length},read:function(b){var f=a.substr(c,b);c+=b;return f},readInt32:function(){var b=(a.charCodeAt(c)<<24)+(a.charCodeAt(c+1)<<16)+(a.charCodeAt(c+2)<<8)+a.charCodeAt(c+3);c+=4;return b},
readInt16:function(){var b=(a.charCodeAt(c)<<8)+a.charCodeAt(c+1);c+=2;return b},readInt8:b,readVarInt:function(){for(var a=0,c=b();c&128;)a+=c&127,a<<=7,c=b();return a+c}}}function w(a){function b(a){var b=a.read(4),c=a.readInt32();return{id:b,length:c,data:a.read(c)}}function c(a){var b={deltaTime:a.readVarInt()},c=a.readInt8(),e,f;if(240===(c&240)){if(255===c)switch(b.type="meta",c=a.readInt8(),e=a.readVarInt(),c){case k.SEQUENCE_NUMMBER:b.subtype="sequenceNumber";if(2!==e)throw"Expected length for sequenceNumber event is 2, got "+
e;b.number=a.readInt16();return b;case k.TEXT:return b.subtype="text",b.text=a.read(e),b;case k.COPYRIGHT_NOTICE:return b.subtype="copyrightNotice",b.text=a.read(e),b;case k.TRACK_NAME:return b.subtype="trackName",b.text=a.read(e),b;case k.INSTRUMENT_NAME:return b.subtype="instrumentName",b.text=a.read(e),b;case k.LYRICS:return b.subtype="lyrics",b.text=a.read(e),b;case k.MARKER:return b.subtype="marker",b.text=a.read(e),b;case k.CUE_POINT:return b.subtype="cuePoint",b.text=a.read(e),b;case k.MIDI_CHANNEL_PREFIX:b.subtype=
"midiChannelPrefix";if(1!==e)throw"Expected length for midiChannelPrefix event is 1, got "+e;b.channel=a.readInt8();return b;case k.END_OF_TRACK:b.subtype="endOfTrack";if(0!==e)throw"Expected length for endOfTrack event is 0, got "+e;return b;case k.SET_TEMPO:b.subtype="setTempo";if(3!==e)throw"Expected length for setTempo event is 3, got "+e;b.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8();return b;case k.SMPTE_OFFSET:b.subtype="smpteOffset";if(5!==e)throw"Expected length for smpteOffset event is 5, got "+
e;c=a.readInt8();b.frameRate={0:24,32:25,64:29,96:30}[c&96];b.hour=c&31;b.min=a.readInt8();b.sec=a.readInt8();b.frame=a.readInt8();b.subframe=a.readInt8();return b;case k.TIME_SIGNATURE:b.subtype="timeSignature";if(4!==e)throw"Expected length for timeSignature event is 4, got "+e;b.numerator=a.readInt8();b.denominator=Math.pow(2,a.readInt8());b.metronome=a.readInt8();b.thirtyseconds=a.readInt8();return b;case k.KEY_SIGNATURE:b.subtype="keySignature";if(2!==e)throw"Expected length for keySignature event is 2, got "+
e;b.key=a.readInt8(!0);b.scale=a.readInt8();return b;case k.SEQUENCER_SPECIFIC:return b.subtype="sequencerSpecific",b.data=a.read(e),b;default:return b.subtype="unknown",b.data=a.read(e),b}else{if(240===c)return b.type="sysEx",e=a.readVarInt(),b.data=a.read(e),b;if(247===c)return b.type="dividedSysEx",e=a.readVarInt(),b.data=a.read(e),b}throw"Unrecognised MIDI event type byte: "+c;}0===(c&128)?(e=c,c=d):(e=a.readInt8(),d=c);f=c&240;b.channel=c&15;b.type="channel";switch(f){case n.NOTE_OFF:return b.subtype=
"noteOff",b.noteNumber=e,b.velocity=a.readInt8(),b;case n.NOTE_ON:return b.noteNumber=e,b.velocity=a.readInt8(),b.subtype=0===b.velocity?"noteOff":"noteOn",b;case n.AFTER_TOUCH:return b.subtype="noteAftertouch",b.noteNumber=e,b.amount=a.readInt8(),b;case n.CONTROL_CHANGE:return b.subtype="controlChange",b.controllerType=e,b.value=a.readInt8(),b;case n.PROGRAM_CHANGE:return b.subtype="programChange",b.programNumber=e,b;case n.CHANNEL_AFTERTOUCH:return b.subtype="channelAftertouch",b.amount=e,b;case n.PITCH_BEND:return b.subtype=
"pitchBend",b.value=e+(a.readInt8()<<7),b;default:throw"Unrecognised MIDI event type: "+f;}}var d;a=v(a);var f=b(a),r=[],g,u,h;if("MThd"!==f.id||6!==f.length)throw"Bad .mid file - header not found";g=v(f.data);f=g.readInt16();u=g.readInt16();g=g.readInt16();if(g&32768)throw"Expressing time division in SMTPE frames is not supported yet";f={formatType:f,trackCount:u,ticksPerBeat:g};for(u=0;u<f.trackCount;u++){r[u]=[];g=b(a);if("MTrk"!==g.id)throw"Unexpected chunk - expected MTrk, got "+g.id;for(g=v(g.data);!g.eof();)h=
c(g),r[u].push(h)}return{header:f,tracks:r}}function C(a){a=/([A-G])(#+|b+)?([0-9]+)$/i.exec(a);var b=a[1].toUpperCase(),c=a[2]||"";return 12*parseInt(a[3],10)+D[b]+("#"===c.substr(0,1)?1:-1)*c.length}function y(a){return"number"!==typeof a&&/[^0-9]/.test(a)?C(a):parseInt(a,10)}function E(a,b){var c=0,d=a;23<a&&(c=Math.floor(a/12)-1,d=a-12*c);a=F[d];b&&0<a.indexOf("#")&&(a=G[a]);return a+c}function H(a){a=Math.floor(6E7/a);var b=[];do b.unshift(a&255),a>>=8;while(a);for(;3>b.length;)b.push(0);return b}
function z(a){return String.fromCharCode.apply(null,a)}function A(a,b){if(b)for(;a.length/2<b;)a="0"+a;b=[];var c,d;for(d=a.length-1;0<=d;d-=2)c=0===d?a[d]:a[d-1]+a[d],b.unshift(parseInt(c,16));return b}function B(a){var b=a&127,c=!0,d=[];for(a>>=7;a;)b<<=8,b|=a&127|128,a>>=7;for(;c;)d.push(b&255),b&128?b>>=8:c=!1;return d}function x(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function I(a,b){return a.concat(b)}function K(a,b){if(b.name.includes("Note"))a["add"+b.name](0,b.midiNote,
b.deltaTime,127*b.velocity);else if(b.name.includes("Sustain"))a["add"+b.name](0,b.deltaTime);return a}function L(a,b,c,d){function f(a){return!a.taken&&a.time===g.time}var r=a[a.length-1],g;if(!a.length)return g=d[0],g.taken=!0,[g];g=d.find(function(a){return!a.taken&&a.time>=r.time});if(!g.duration)return g.taken=!0,a.concat(g);g=d.filter(f).find(function(a){return a.name.includes("Off")})||d.filter(f).find(function(a){return a.duration>g.duration})||g;g.taken=!0;return a.concat(g)}function M(a,
b){return a.time-b.time}function N(a){if("undefined"!==typeof a.midiNote)return[{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOn",time:parseInt(a.time),velocity:a.velocity},{duration:parseInt(a.duration),midiNote:a.midiNote,name:"NoteOff",time:parseInt(a.time)+parseInt(a.duration),velocity:a.velocity}];if("sustain"===a.eventName)return[{name:"SustainOn",time:parseInt(a.time)},{name:"SustainOff",time:parseInt(a.time)+parseInt(a.duration)}]}function O(a,b,c,d){return a.concat({duration:b.duration,
time:b.time,name:b.name,midiNote:b.midiNote,deltaTime:0!==a.length?b.time-d[c-1].time:b.time,velocity:b.velocity})}function P(a,b,c,d){a=d[c-1];0<c&&0===b.deltaTime&&"noteOff"===b.subtype&&"noteOn"===a.subtype&&b.noteNumber===a.noteNumber&&(b.deltaTime=a.deltaTime,a.deltaTime=0,d[c]=a,d[c-1]=b);return d}function Q(a,b){a[b.noteNumber]=a[b.noteNumber]||[];a[b.noteNumber].push(b);return a}function R(a){return a.some(function(a,c,d){return 0<c&&"noteOn"===a.subtype&&a.subtype===d[c-1].subtype})}function S(a,
b){var c=parseInt(a.time)-parseInt(b.time),d=a.midiNote&&b.midiNote&&a.midiNote-b.midiNote,f=parseInt(b.duration)-parseInt(a.duration);a=b.velocity-a.velocity;return c||d||f||a}function T(a,b){if(b=b.filter(function(a){return"programChange"===a.subtype}).pop())a.instrumentsMap[b.channel]=9===b.channel?0:b.programNumber+1,a._instrumentsMap[b.channel]=9===b.channel?"percussion":b.programNumber;return a}function U(a){return(a=a.filter(function(a){return"timeSignature"===a.subtype}).pop())?[a.numerator,
a.denominator]:null}function V(a){return(a=a.filter(function(a){return"setTempo"===a.subtype}).pop())?6E7/a.microsecondsPerBeat:null}function W(a){var b=0;a=a.reduce(function(a,d){var f=d.channel||0,r;a[f]=a[f]||[];r=a[f][a[f].length-1];a[f].push(d);b+=d.deltaTime;d.absoluteTime=b;d.deltaTime=r?d.absoluteTime-r.absoluteTime:d.absoluteTime;return a},{});return x(a)}var n={NOTE_OFF:128,NOTE_ON:144,AFTER_TOUCH:160,CONTROL_CHANGE:176,CONTROLLER:{DAMPER_PEDAL:64},PROGRAM_CHANGE:192,CHANNEL_AFTERTOUCH:208,
PITCH_BEND:224},k={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,PROGRAM_NAME:8,DEVICE_NAME:9,MIDI_CHANNEL_PREFIX:32,MIDI_PORT:33,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127},G={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"},D={A:21,B:23,C:12,D:14,E:16,F:17,G:19},F={12:"C",13:"C#",14:"D",15:"D#",16:"E",17:"F",18:"F#",19:"G",20:"G#",21:"A",22:"A#",23:"B"},t=function(a){if(!this)return new t(a);
this.setTime(a.time);this.setType(a.type);this.setData(a.data)};t.prototype.setTime=function(a){this.time=B(a||0)};t.prototype.setType=function(a){this.type=a};t.prototype.setData=function(a){this.data=a};t.prototype.toBytes=function(){if(!this.type)throw Error("Type for meta-event not specified.");var a=[],b;a.push.apply(a,this.time);a.push(255,this.type);Array.isArray(this.data)?(a.push(this.data.length),a.push.apply(a,this.data)):"number"===typeof this.data?a.push(1,this.data):null!==this.data&&
"undefined"!==typeof this.data?(a.push(this.data.length),b=this.data.split("").map(function(a){return a.charCodeAt(0)}),a.push.apply(a,b)):a.push(0);return a};var m=function(a){if(!this)return new m(a);!a||null===a.type&&"undefined"===typeof a.type||null===a.channel&&"undefined"===typeof a.channel||null===a.param1&&"undefined"===typeof a.param1||(this.setTime(a.time),this.setType(a.type),this.setChannel(a.channel),this.setParam1(a.param1),this.setParam2(a.param2))};m.prototype.setTime=function(a){this.time=
B(a||0)};m.prototype.setType=function(a){if(a<n.NOTE_OFF||a>n.PITCH_BEND)throw Error("Trying to set an unknown event: "+a);this.type=a};m.prototype.setChannel=function(a){if(0>a||15<a)throw Error("Channel is out of bounds.");this.channel=a};m.prototype.setParam1=function(a){this.param1=a};m.prototype.setParam2=function(a){this.param2=a};m.prototype.toBytes=function(){var a=[],b=this.type|this.channel&15;a.push.apply(a,this.time);a.push(b);a.push(this.param1);"undefined"!==typeof this.param2&&null!==
this.param2&&a.push(this.param2);return a};var h;h=function(a){if(!this)return new h(a);this.events=(a||{}).events||[]};h.START_BYTES=[77,84,114,107];h.END_BYTES=[0,255,47,0];h.prototype.addEvent=function(a){this.events.push(a);return this};h.prototype.addNoteOn=function(a,b,c,d){this.events.push(new m({type:n.NOTE_ON,channel:a,param1:y(b),param2:d||90,time:c||0}));return this};h.prototype.addNoteOff=function(a,b,c,d){this.events.push(new m({type:n.NOTE_OFF,channel:a,param1:y(b),param2:d||90,time:c||
0}));return this};h.prototype.addSustainOn=function(a,b){this.events.push(new m({type:n.CONTROL_CHANGE,channel:a,param1:n.CONTROLLER.DAMPER_PEDAL,param2:127,time:b||0}));return this};h.prototype.addSustainOff=function(a,b){this.events.push(new m({type:n.CONTROL_CHANGE,channel:a,param1:n.CONTROLLER.DAMPER_PEDAL,param2:0,time:b||0}));return this};h.prototype.addNote=function(a,b,c,d,f){this.noteOn(a,b,d,f);c&&this.noteOff(a,b,c,f);return this};h.prototype.addChord=function(a,b,c,d){if(!Array.isArray(b)&&
!b.length)throw Error("Chord must be an array of pitches");b.forEach(function(b){this.noteOn(a,b,0,d)},this);b.forEach(function(b,d){0===d?this.noteOff(a,b,c):this.noteOff(a,b)},this);return this};h.prototype.setInstrument=function(a,b,c){this.events.push(new m({type:n.PROGRAM_CHANGE,channel:a,param1:b,time:c||0}));return this};h.prototype.setTimeSignature=function(a,b,c){this.events.push(new t({type:k.TIME_SIGNATURE,data:[a,Math.log2(b),24,8],time:c||0}));return this};h.prototype.setTempo=function(a,
b){this.events.push(new t({type:k.SET_TEMPO,data:H(a),time:b||0}));return this};h.prototype.toBytes=function(){var a=0,b=[],c,d=h.START_BYTES,f=h.END_BYTES;this.events.forEach(function(c){c=c.toBytes();a+=c.length;b.push.apply(b,c)});a+=f.length;c=A(a.toString(16),4);return d.concat(c,b,f)};var p=function(a){if(!this)return new p(a);a=a||{};if(a.ticks){if("number"!==typeof a.ticks)throw Error("Ticks per beat must be a number!");if(0>=a.ticks||32768<=a.ticks||0!==a.ticks%1)throw Error("Ticks per beat must be an integer between 1 and 32767!");
}this.ticks=a.ticks||128;this.tracks=a.tracks||[]};p.HDR_CHUNKID="MThd";p.HDR_CHUNK_SIZE="\x00\x00\x00\u0006";p.HDR_TYPE0="\x00\x00";p.HDR_TYPE1="\x00\u0001";p.prototype.addTrack=function(a){if(a)return this.tracks.push(a),this;a=new h;this.tracks.push(a);return a};p.prototype.toBytes=function(){var a=this.tracks.length.toString(16),b=p.HDR_CHUNKID+p.HDR_CHUNK_SIZE,b=1<parseInt(a,16)?b+p.HDR_TYPE1:b+p.HDR_TYPE0,b=b+z(A(a,2)),b=b+String.fromCharCode(this.ticks/256,this.ticks%256);this.tracks.forEach(function(a){b+=
z(a.toBytes())});return b};var J={File:p,Track:h,MidiEvent:m,MetaEvent:t,Util:{midiLetterPitches:D,midiPitchesLetter:F,midiFlattenedNotes:G,midiPitchFromNote:C,ensureMidiPitch:y,noteFromMidiPitch:E,mpqnFromBpm:H,bpmFromMpqn:function(a){return Math.floor(6E7/a)},codes2Str:z,str2Bytes:A,translateTickTime:B}};return{generate:function(a){var b=new J.File;a.parts.forEach(function(c,d){var f=b.addTrack();a.transport.bpm&&f.setTempo(a.transport.bpm);a.transport._instruments&&"undefined"!==typeof a.transport._instruments[d]&&
f.setInstrument("percussion"===a.transport._instruments[d]?9:9<=d?d+1:d,a.transport._instruments[d]);a.transport.timeSignature&&f.setTimeSignature(a.transport.timeSignature[0],a.transport.timeSignature[1]);c.map(N).reduce(I,[]).sort(M).reduce(L,[]).reduce(O,[]).reduce(K,f)});return b.toBytes()},MidiGen:J,parse:function(a,b){var c=w(a);0===c.header.formatType&&(c.tracks=W(c.tracks[0]));var d=c.header.ticksPerBeat;a=[];var f=!1,h,g,k,m,p,q,l,e;b=Object.assign({duration:!0,noteName:!0,PPQ:128,velocity:!0},
b);for(m=0;m<c.tracks.length;m++){h=c.tracks[m];g=[];k=0;b.duration&&x(h.reduce(Q,{})).some(R)&&(h=h.reduce(P));for(p=0;p<h.length;p++)if(l=h[p],k+=l.deltaTime,"noteOn"===l.subtype)q={_note:l.noteNumber,_ticks:k,midiNote:l.noteNumber,time:k},b.noteName&&(q.noteName=E(l.noteNumber)),b.velocity&&(q.velocity=l.velocity/127),g.push(q);else if("noteOff"===l.subtype)for(q=g.length-1;0<=q;q--){if(e=g[q],e._note===l.noteNumber&&"undefined"===typeof e.duration){b.duration&&(e.duration=Math.round((k-e._ticks)/
d*b.PPQ)+"i");e.time=Math.round(e.time/d*b.PPQ)+"i";delete e._note;delete e._ticks;break}}else if("meta"===l.type&&"trackName"===l.subtype)l=l.text,l.replace(/\u0000/g,"");else if(l.controllerType===n.CONTROLLER.DAMPER_PEDAL)if(64<=l.value&&!f)l={_ticks:k,eventName:"sustain",time:k},f=!0,g.push(l);else if(64>l.value&&f){for(q=g.length-1;0<=q;q--)if(e=g[q],"sustain"===e.eventName&&"undefined"===typeof e.duration){b.duration&&(e.duration=Math.round((k-e._ticks)/d*b.PPQ)+"i");e.time=Math.round(e.time/
d*b.PPQ)+"i";delete e._note;delete e._ticks;break}f=!1}b.deterministic&&(g=g.sort(S));0<g.length&&a.push(g)}d=c.tracks.reduce(I,[]);c=c.tracks.reduce(T,{_instrumentsMap:{},instrumentsMap:{}});c={_instruments:x(c._instrumentsMap),bpm:V(d),instruments:x(c.instrumentsMap),timeSignature:U(d)};return{parts:a,transport:c}}}});

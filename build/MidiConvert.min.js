'use strict';(function(q,r){"object"===typeof exports&&"undefined"!==typeof module?module.exports=r():"function"===typeof define&&define.amd?define(r):q.MidiConvert=r()})(this,function(){function q(g){function e(e){var f=g.charCodeAt(k);e&&127<f&&(f-=256);k+=1;return f}var k=0;return{eof:function(){return k>=g.length},read:function(e){var f=g.substr(k,e);k+=e;return f},readInt32:function(){var e=(g.charCodeAt(k)<<24)+(g.charCodeAt(k+1)<<16)+(g.charCodeAt(k+2)<<8)+g.charCodeAt(k+3);k+=4;return e},
readInt16:function(){var e=(g.charCodeAt(k)<<8)+g.charCodeAt(k+1);k+=2;return e},readInt8:e,readVarInt:function(){for(var g=0,f=e();f&128;)g+=f&127,g<<=7,f=e();return g+f}}}function r(g){function e(c){var a=c.read(4),d=c.readInt32();return{id:a,length:d,data:c.read(d)}}function k(c){var a={deltaTime:c.readVarInt()},d=c.readInt8(),b,e;if(240===(d&240)){if(255===d)switch(a.type="meta",d=c.readInt8(),b=c.readVarInt(),d){case 0:a.subtype="sequenceNumber";if(2!==b)throw"Expected length for sequenceNumber event is 2, got "+
b;a.number=c.readInt16();return a;case 1:return a.subtype="text",a.text=c.read(b),a;case 2:return a.subtype="copyrightNotice",a.text=c.read(b),a;case 3:return a.subtype="trackName",a.text=c.read(b),a;case 4:return a.subtype="instrumentName",a.text=c.read(b),a;case 5:return a.subtype="lyrics",a.text=c.read(b),a;case 6:return a.subtype="marker",a.text=c.read(b),a;case 7:return a.subtype="cuePoint",a.text=c.read(b),a;case 32:a.subtype="midiChannelPrefix";if(1!==b)throw"Expected length for midiChannelPrefix event is 1, got "+
b;a.channel=c.readInt8();return a;case 47:a.subtype="endOfTrack";if(0!==b)throw"Expected length for endOfTrack event is 0, got "+b;return a;case 81:a.subtype="setTempo";if(3!==b)throw"Expected length for setTempo event is 3, got "+b;a.microsecondsPerBeat=(c.readInt8()<<16)+(c.readInt8()<<8)+c.readInt8();return a;case 84:a.subtype="smpteOffset";if(5!==b)throw"Expected length for smpteOffset event is 5, got "+b;d=c.readInt8();a.frameRate={0:24,32:25,64:29,96:30}[d&96];a.hour=d&31;a.min=c.readInt8();
a.sec=c.readInt8();a.frame=c.readInt8();a.subframe=c.readInt8();return a;case 88:a.subtype="timeSignature";if(4!==b)throw"Expected length for timeSignature event is 4, got "+b;a.numerator=c.readInt8();a.denominator=Math.pow(2,c.readInt8());a.metronome=c.readInt8();a.thirtyseconds=c.readInt8();return a;case 89:a.subtype="keySignature";if(2!==b)throw"Expected length for keySignature event is 2, got "+b;a.key=c.readInt8(!0);a.scale=c.readInt8();return a;case 127:return a.subtype="sequencerSpecific",
a.data=c.read(b),a;default:return a.subtype="unknown",a.data=c.read(b),a}else{if(240===d)return a.type="sysEx",b=c.readVarInt(),a.data=c.read(b),a;if(247===d)return a.type="dividedSysEx",b=c.readVarInt(),a.data=c.read(b),a}throw"Unrecognised MIDI event type byte: "+d;}0===(d&128)?(b=d,d=n):(b=c.readInt8(),n=d);e=d>>4;a.channel=d&15;a.type="channel";switch(e){case 8:return a.subtype="noteOff",a.noteNumber=b,a.velocity=c.readInt8(),a;case 9:return a.noteNumber=b,a.velocity=c.readInt8(),a.subtype=0===
a.velocity?"noteOff":"noteOn",a;case 10:return a.subtype="noteAftertouch",a.noteNumber=b,a.amount=c.readInt8(),a;case 11:return a.subtype="controller",a.controllerType=b,a.value=c.readInt8(),a;case 12:return a.subtype="programChange",a.programNumber=b,a;case 13:return a.subtype="channelAftertouch",a.amount=b,a;case 14:return a.subtype="pitchBend",a.value=b+(c.readInt8()<<7),a;default:throw"Unrecognised MIDI event type: "+e;}}var n;g=q(g);var f=e(g),m=[],h,l,p;if("MThd"!==f.id||6!==f.length)throw"Bad .mid file - header not found";
h=q(f.data);f=h.readInt16();l=h.readInt16();h=h.readInt16();if(h&32768)throw"Expressing time division in SMTPE frames is not supported yet";f={formatType:f,trackCount:l,ticksPerBeat:h};for(l=0;l<f.trackCount;l++){m[l]=[];h=e(g);if("MTrk"!==h.id)throw"Unexpected chunk - expected MTrk, got "+h.id;for(h=q(h.data);!h.eof();)p=k(h),m[l].push(p)}return{header:f,tracks:m}}function t(g){var e=[],k;for(k in g)g.hasOwnProperty(k)&&e.push(g[k]);return e}return{parse:function(g,e){g=r(g);if(0===g.header.formatType){var k=
{},n=0,f,m,h,l;for(l=0;l<g.tracks[0].length;l++)f=g.tracks[0][l],m=f.channel||0,n+=f.deltaTime,f.absoluteTime=n,k[m]=k[m]||[],h=k[m][k[m].length-1],k[m].push(f),f.deltaTime=h?f.absoluteTime-h.absoluteTime:f.absoluteTime;g.tracks=t(k);g.header.trackCount=0}n=g.header.ticksPerBeat;k=[];f=!1;var p,c,a,d,b;e=e||{};e.PPQ="undefined"===typeof e.PPQ?192:e.PPQ;e.noteName="undefined"===typeof e.noteName?!0:e.noteName;e.duration="undefined"===typeof e.duration?!0:e.duration;e.velocity="undefined"===typeof e.velocity?
!0:e.velocity;for(l=0;l<g.tracks.length;l++){p=g.tracks[l];m=[];h=0;if(e.duration){c=p;p=c.slice();b:{d={};for(a=0;a<c.length;){b=c[a];if("noteOn"===b.subtype&&d[b.noteNumber]){c=!0;break b}"noteOn"===b.subtype?d[b.noteNumber]=!0:"noteOff"===b.subtype&&(d[b.noteNumber]=!1);a++}c=!1}if(c)for(c=1;c<p.length-1;c++)d=p[c],a=p[c-1],0===d.deltaTime&&"noteOff"===d.subtype&&"noteOn"===a.subtype&&d.noteNumber===a.noteNumber&&(b=d.deltaTime,d.deltaTime=a.deltaTime,a.deltaTime=b,p[c]=a,p[c-1]=d)}for(c=0;c<p.length;c++)if(d=
p[c],h+=d.deltaTime,"noteOn"===d.subtype)a={_note:d.noteNumber,_ticks:h,midiNote:d.noteNumber,time:h},e.noteName&&(b=d.noteNumber,a.noteName="C C# D D# E F F# G G# A A# B".split(" ")[b%12]+(Math.floor(b/12)-1)),e.velocity&&(a.velocity=d.velocity/127),m.push(a);else if("noteOff"===d.subtype)for(a=m.length-1;0<=a;a--){if(b=m[a],b._note===d.noteNumber&&"undefined"===typeof b.duration){e.duration&&(b.duration=Math.round((h-b._ticks)/n*e.PPQ)+"i");b.time=Math.round(b.time/n*e.PPQ)+"i";delete b._note;delete b._ticks;
break}}else if("meta"===d.type&&"trackName"===d.subtype)d=d.text,d.replace(/\u0000/g,"");else if(64===d.controllerType)if(64<=d.value&&!f)d={_ticks:h,eventName:"sustain",time:h},f=!0,m.push(d);else if(64>d.value&&f){for(a=m.length-1;0<=a;a--)if(b=m[a],"sustain"===b.eventName&&"undefined"===typeof b.duration){e.duration&&(b.duration=Math.round((h-b._ticks)/n*e.PPQ)+"i");b.time=Math.round(b.time/n*e.PPQ)+"i";delete b._note;delete b._ticks;break}f=!1}0<m.length&&k.push(m)}n={};f={};for(m=0;m<g.tracks.length;m++)for(e=
g.tracks[m],h=0;h<e.length;h++)l=e[h],"meta"===l.type?"timeSignature"===l.subtype?n.timeSignature=[l.numerator,l.denominator]:"setTempo"===l.subtype&&(n.bpm=6E7/l.microsecondsPerBeat):"channel"===l.type&&"programChange"===l.subtype&&(f[l.channel]=9===l.channel?0:l.programNumber+1);n.instruments=t(f);return{parts:k,transport:n}}}});
